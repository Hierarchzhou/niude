# 聊天应用改进

## 主要改进

1. **WebSocket连接管理**
   - 添加了`ConnectionManager`类，用于管理WebSocket连接
   - 实现了用户与服务器的关联，确保消息只发送给正确的接收者
   - 添加了连接状态跟踪和错误处理

2. **服务器切换功能**
   - 实现了在切换服务器时加载该服务器的历史消息
   - 添加了服务器成员检查，确保用户只能访问其所属的服务器
   - 优化了UI交互，提供更好的用户体验

3. **消息处理改进**
   - 添加了消息类型（聊天消息、系统消息、错误消息）
   - 实现了消息过滤，确保只显示当前选中服务器的消息
   - 添加了消息发送状态和错误处理

4. **API端点**
   - 添加了获取服务器历史消息的API端点
   - 优化了WebSocket端点，支持token认证
   - 改进了消息广播机制，支持按服务器广播

## 使用说明

1. 启动应用后，用户需要先登录
2. 登录后，用户可以查看和加入服务器
3. 选择服务器后，可以查看该服务器的历史消息并发送新消息
4. 消息会实时显示，无需刷新页面

## 技术细节

- 使用FastAPI的WebSocket支持实现实时通信
- 使用JWT进行用户认证
- 使用SQLAlchemy进行数据库操作
- 前端使用原生JavaScript实现WebSocket通信和UI交互

## 未来改进

- 添加消息未读提示
- 实现私聊功能
- 添加文件和图片分享功能
- 优化移动端体验

## 功能特点

- 实时聊天：使用WebSocket实现实时消息传递
- 消息存储：所有消息保存在SQLite数据库中
- 用户系统：支持用户注册和登录
- 用户列表：显示所有注册用户
- 简洁界面：简单易用的聊天界面

## 技术栈

- 后端：FastAPI (Python)
- 数据库：SQLite
- 实时通信：WebSocket
- 前端：HTML, CSS, JavaScript

## 安装和运行

### 1. 安装依赖

```bash
pip install -r requirements.txt
```

### 2. 运行应用

```bash
cd chat-app
uvicorn app:app --reload --host 0.0.0.0 --port 8000
```

### 3. 访问应用

打开浏览器，访问：
```
http://localhost:8000
```

## 使用方法

### 注册和登录

1. 访问应用首页，会自动跳转到登录页面
2. 如果没有账号，点击"立即注册"链接
3. 填写用户名、邮箱和密码进行注册
4. 注册成功后会自动登录并进入聊天页面

### 聊天功能

1. 登录后进入聊天页面
2. 左侧显示当前用户信息和所有用户列表
3. 右侧是聊天区域
4. 在底部输入框中输入消息
5. 点击"发送"按钮或按Enter键发送消息
6. 您发送的消息将显示在右侧，其他人的消息显示在左侧

### 退出登录

点击左侧底部的"退出登录"按钮即可退出登录

## 项目结构

- `app.py`: 主应用文件，包含FastAPI应用和WebSocket处理逻辑
- `database.py`: 数据库连接和模型定义
- `static/`: 静态文件目录
  - `login.html`: 登录页面
  - `register.html`: 注册页面
  - `chat.html`: 聊天页面
- `chat.db`: SQLite数据库文件（运行后自动创建）

## 下一步计划

- 添加聊天室功能
- 添加私聊功能
- 添加消息编辑和删除功能
- 添加文件和图片分享功能
- 添加用户在线状态显示 